name: Java CI/CD with JAR Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package --file pom.xml

      - name: Upload JAR to server via SSH
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "target/*.jar"
          target: "/opt/springapp/"
          strip_components: 1

      - name: Restart Spring Boot App on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/springapp
            # Find and kill the existing application
            APP_PID=$(pgrep -f 'spring-boot-ci-cd-with-docker' || echo "")
            if [ ! -z "$APP_PID" ]; then
              echo "Stopping existing application with PID: $APP_PID"
              kill $APP_PID
              sleep 5
              # Force kill if still running
              if ps -p $APP_PID > /dev/null; then
                kill -9 $APP_PID
                sleep 2
              fi
            fi
            
            # Find the JAR file (handles version changes)
            JAR_FILE=$(ls *.jar | head -n 1)
            if [ -z "$JAR_FILE" ]; then
              echo "❌ No JAR file found!"
              exit 1
            fi
            
            echo "Starting application: $JAR_FILE"
            nohup java -jar "$JAR_FILE" > app.log 2>&1 &
            
            # Wait for app to start
            sleep 10
            
            # Verify the application started successfully
            if pgrep -f 'spring-boot-ci-cd-with-docker' > /dev/null; then
              echo "✅ Spring Boot app restarted successfully"
              echo "Application is running with PID: $(pgrep -f 'spring-boot-ci-cd-with-docker')"
            else
              echo "❌ Failed to start Spring Boot app"
              echo "Last 50 lines of app.log:"
              tail -50 app.log
              exit 1
            fi

#    - name: Build and Push Docker Image
#      uses: mr-smithers-excellent/docker-build-push@v4
#      with:
#        image: raselahmedb/spring-boot-ci-cd-with-docker
#        registry: docker.io
#        username: ${{ secrets.DOCKER_USERNAME }}
#        password: ${{ secrets.DOCKER_PASSWORD }}

    # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
    #- name: Update dependency graph
    #  uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
