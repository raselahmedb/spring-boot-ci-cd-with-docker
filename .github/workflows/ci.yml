

name: Java CI/CD with JAR Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package --file pom.xml

      - name: Upload JAR to server via SSH
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "target/*.jar"
          target: "/opt/springapp/"
          strip_components: 1

      - name: Restart Spring Boot App on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10m
          script: |
            cd /opt/springapp
            pkill -f 'spring-boot-ci-cd-with-docker' || true
            nohup /usr/bin/java -jar /opt/springapp/spring-boot-ci-cd-with-docker-0.0.1-SNAPSHOT.jar > /opt/springapp/app.log 2>&1 &
            sleep 5
            if pgrep -f 'spring-boot-ci-cd-with-docker' > /dev/null; then
              echo "✅ Spring Boot app restarted successfully"
            else
              echo "❌ Spring Boot app failed to start"
              exit 1
            fi

#    - name: Build and Push Docker Image
#      uses: mr-smithers-excellent/docker-build-push@v4
#      with:
#        image: raselahmedb/spring-boot-ci-cd-with-docker
#        registry: docker.io
#        username: ${{ secrets.DOCKER_USERNAME }}
#        password: ${{ secrets.DOCKER_PASSWORD }}

    # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
    #- name: Update dependency graph
    #  uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
